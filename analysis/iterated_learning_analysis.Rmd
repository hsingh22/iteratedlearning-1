---
title: "iterated_learning"
author: "Maddie Meyers, Dan Yurovsky"
date: "7/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(png)
library(grid)
library(xtable)
library(feather)
library(irr)
library(tidyboot)
library(directlabels)
library(lme4)
library(broom)
library(acss)
library(devtools)
library(reshape2)

theme_set(theme_classic(base_size = 10))
```

## Setup

```{r load csv}
data2 <- read_csv("../data/anonymized_data.csv")
kidData<-read_csv("iteratedstudyresults.csv")
practice_data <- matrix(sample(0:1, 64, replace=TRUE), nrow=8, ncol=8)

#filters out people who didn't complete 10 trials
data <- data2 %>%
#data<-kidData %>%
 arrange(sub_id, trialDisplay) %>%
  group_by(sub_id) %>%
  mutate(n = n()) %>%
  filter(n >= 12 & condition != "test" & sub_id != 0) %>%
 # filter(condition == "pilotkid" & sub_id != "Xx" & sub_id != "sdgd" & sub_id != 1) %>%
  select(-n) %>%
  ungroup() %>%
  filter(trialCount < 14)
```

```{r}
spread_data <- data %>%
  gather(row, value, -sub_id, -age, -condition, -generation, -date, -time, -trialDisplay, -trialCount, -comments)%>%
  arrange(sub_id, trialDisplay) %>%
  separate(row, c("type","row", "col")) %>%
  unite(ty_col, type, col) %>%
  spread(ty_col, value) %>%
  filter(is.na(row)==F)
```

```{r formats data}
calculate_data <- data %>%
  gather(row, value,-sub_id:-trialDisplay)%>%
  arrange(sub_id, trialDisplay) %>%
  separate(row, c("type","row", "col")) %>%
  spread(type,value) %>%
  mutate(input = as.numeric(input), target = as.numeric(target),
         row = as.numeric(row), column = as.numeric(col)) %>%
  mutate(accuracy = input == target,
         sub_id = as.character(sub_id)) 
```
## Descriptive
Displays the actual grids that people made 
```{r plot_grids}
pdf("trial_data_adults.pdf", width = 10, height = 10)
calculate_data %>%
  distinct(trialDisplay, row, col, target) %>%
  mutate(sub_id = "target") %>%
  rename(input = target) %>%
  bind_rows(select(calculate_data, sub_id, trialDisplay, row, col, input)) %>%
  mutate(input = factor(input), sub_id = factor(sub_id, levels = unique(.$sub_id))) %>%
  mutate(row = 7 - row) %>%
  ggplot(aes(x = col, y = row, fill = input)) +
  facet_grid(trialDisplay ~ sub_id) +
  geom_tile(color = "black") +
  scale_fill_manual(values = c("0" = "white", "1" = "black"), guide = F)
dev.off()
```

## Analysis
Percent accuracies calculated by %/10 targets placed correctly 
```{r accuracy}
trial_data <- calculate_data %>%
  filter(target == 1) %>%
  filter(trialDisplay > 0) %>%
 # filter(sub_id == 5 | sub_id == 2) %>%
  group_by(trialCount, sub_id) %>%
  summarise(accuracy = mean(accuracy)) %>%
  tidyboot_mean(accuracy) 

ggplot(trial_data, aes(x = trialCount, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper)) + 
  geom_pointrange() + 
  geom_smooth()
```

Clustering: # of identifiable touching "parts"(excluding diagonals). This function was taken from Gauvrit et al 2017. 
```{r}

```

Density: measured as edge length. Taken from Gauvrit et al 2017
```{r}

```

Want a function that can summarize over every set of 8 rows 
```{r}
bdm_function = function(m){
  x = rep("x", nrow(m)/8)
  k=1
  q=1
  for(i in 1:(nrow(m)/8)){
    df = m[q:(q+7), 5:12]
    data.matrix(df)
    x[k] = bdm(df)
    k = k +1
    q=q+8
  }
  return(x) 
}
```

```{r}
nPart_function = function(m){
  x = rep("x", nrow(m)/8)
  k=1
  q=1
  for(i in 1:(nrow(m)/8)){
    df = m[q:(q+7), 5:12]
    data.matrix(df)
    x[k] = nPart(df)
    k = k +1
    q=q+8
  }
  return(x) 
}
```

```{r}
edge_function = function(m){
  x = rep("x", nrow(m)/8)
  k=1
  q=1
  for(i in 1:(nrow(m)/8)){
    df = m[q:(q+7), 5:12]
    data.matrix(df)
    x[k] = edge(df)
    k = k +1
    q=q+8
  }
  return(x) 
}
```

Algorithmic Complexity: Block Decomposition Method [do you need to install the function every time?]
```{r}
bdm_data <- spread_data %>%
  filter(trialDisplay != 0) %>%
  select(sub_id, generation, trialDisplay, row, input_0:input_7) %>%
  mutate(input_7 = as.numeric(input_7),
         input_6 = as.numeric(input_6),
         input_5 = as.numeric(input_5),
         input_4 = as.numeric(input_4),
         input_3 = as.numeric(input_3),
         input_2 = as.numeric(input_2),
         input_1 = as.numeric(input_1),
         input_0 = as.numeric(input_0)) 

target_data <- spread_data %>%
  filter(trialDisplay != 0) %>%
  select(sub_id, generation, trialDisplay, row, target_0:target_7) %>%
  mutate(sub_id = 0, generation = 0) %>%
  unique(.) %>%
  mutate(target_7 = as.numeric(target_7),
         target_6 = as.numeric(target_6),
         target_5 = as.numeric(target_5),
         target_4 = as.numeric(target_4),
         target_3 = as.numeric(target_3),
         target_2 = as.numeric(target_2),
         target_1 = as.numeric(target_1),
         target_0 = as.numeric(target_0)) 
 
target_store <- data.frame(bdm = bdm_function(target_data),
                           chunking = nPart_function(target_data),
                           edge = edge_function(target_data)) 
bdm_store <- data.frame(bdm = bdm_function(bdm_data),
                        chunking = nPart_function(bdm_data),
                        edge = edge_function(bdm_data))

bind_targets <- target_data %>%
  mutate(generation = 0) %>%
  group_by(sub_id, trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(target_store, .)

bind_data <- bdm_data %>%
  group_by(sub_id, trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(bdm_store, .) %>%
  bind_rows(. , bind_targets) %>%
  mutate(bdm = as.numeric(bdm),
         chunking = as.numeric(chunking),
         edge = as.numeric(edge)) %>%
  group_by(sub_id, trialDisplay, generation)%>%
  summarise(bdm_mean = mean(bdm),
            chunking_mean = mean(chunking),
            edge_mean = mean(edge)) %>%
  group_by(trialDisplay, generation) %>%
  #group_by(generation) %>%
  #tidyboot_mean(bdm_mean) 
  #tidyboot_mean(chunking_mean)
  tidyboot_mean(edge_mean)

```

```{r display complexity values}
ggplot(bind_data, aes(x = trialDisplay, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper)) + 
  geom_pointrange() + facet_wrap(~generation) + geom_smooth()


ggplot(bind_data, aes(x=generation, y=bdm_mean)) + geom_point()
```

```{r}
target_store <- data.frame(b = bdm_function(target_data)) 
bdm_store <- data.frame(bdm = bdm_function(bdm_data))

bind_targets <- target_data %>%
  mutate(generation = 0) %>%
  group_by(sub_id, trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(target_store, .)

bind_data <- bdm_data %>%
  group_by(sub_id, trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(bdm_store, .) %>%
  bind_rows(. , bind_targets) %>%
  mutate(bdm = as.numeric(bdm)) %>%
  group_by(sub_id, trialDisplay, generation)%>%
  summarise(bdm_mean = mean(bdm)) %>%
  group_by(trialDisplay, generation) %>%
  #group_by(generation) %>%
  tidyboot_mean(bdm_mean) 

```

